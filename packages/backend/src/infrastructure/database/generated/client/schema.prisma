model Analytics {
  id        String             @id @default(uuid())
  siteId    String             @map("site_id")
  eventType AnalyticsEventType @map("event_type")
  sessionId String             @map("session_id")
  metadata  Json               @default("{}")
  createdAt DateTime           @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@map("analytics")
}

model ApiKey {
  id                String    @id @default(uuid())
  siteId            String    @unique @map("site_id")
  key               String    @unique
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  lastRegeneratedAt DateTime? @map("last_regenerated_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model ChatMessage {
  id             String   @id @default(uuid())
  siteId         String   @map("site_id")
  sessionId      String   @map("session_id")
  message        String
  response       String
  responseTimeMs Int      @map("response_time_ms")
  createdAt      DateTime @default(now()) @map("created_at")

  site   Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  rating ChatRating?

  @@map("chat_messages")
}

model ChatRating {
  id            String     @id @default(uuid())
  chatMessageId String     @unique @map("chat_message_id")
  siteId        String     @map("site_id")
  sessionId     String     @map("session_id")
  rating        RatingType
  feedback      String?
  createdAt     DateTime   @default(now()) @map("created_at")

  chatMessage ChatMessage @relation(fields: [chatMessageId], references: [id], onDelete: Cascade)
  site        Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@map("chat_ratings")
}

model CustomKnowledge {
  id        String   @id @default(uuid())
  siteId    String   @map("site_id")
  title     String
  content   String
  vectorId  String   @map("vector_id")
  createdAt DateTime @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@map("custom_knowledge")
}

enum SiteStatus {
  pending
  crawling
  active
  error
}

enum TooltipPosition {
  top
  bottom
  left
  right
}

enum AnalyticsEventType {
  walkthrough_started
  walkthrough_completed
  walkthrough_skipped
  chat_message
}

enum OAuthProvider {
  google
  facebook
  telegram
  github
  apple
}

enum UnansweredQuestionStatus {
  new
  contacted
  resolved
}

enum RatingType {
  positive
  negative
}

model KnowledgeBase {
  id        String   @id @default(uuid())
  siteId    String   @map("site_id")
  pageUrl   String   @map("page_url")
  content   String
  vectorId  String   @map("vector_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@map("knowledge_bases")
}

model OAuthAccount {
  id                String        @id @default(uuid())
  userId            String        @map("user_id")
  provider          OAuthProvider
  providerAccountId String        @map("provider_account_id")
  email             String?
  displayName       String?       @map("display_name")
  avatarUrl         String?       @map("avatar_url")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
}

model Site {
  id                  String     @id @default(uuid())
  userId              String     @map("user_id")
  url                 String
  domain              String
  name                String?
  status              SiteStatus @default(pending)
  triggerDelaySeconds Int        @default(5) @map("trigger_delay_seconds")
  additionalUrls      String[]   @default([]) @map("additional_urls")
  lastCrawledAt       DateTime?  @map("last_crawled_at")
  errorMessage        String?    @map("error_message")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  // Chat widget settings
  similarityThreshold   Decimal @default(0.20) @map("similarity_threshold") @db.Decimal(3, 2)
  allowGeneralKnowledge Boolean @default(false) @map("allow_general_knowledge")
  maxMessagesPerSession Int     @default(15) @map("max_messages_per_session")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  apiKey              ApiKey?
  walkthroughSteps    WalkthroughStep[]
  knowledgeBases      KnowledgeBase[]
  customKnowledge     CustomKnowledge[]
  chatMessages        ChatMessage[]
  analytics           Analytics[]
  unansweredQuestions UnansweredQuestion[]
  chatRatings         ChatRating[]
  widgetSessions      WidgetSession[]

  @@unique([userId, domain])
  @@map("sites")
}

model UnansweredQuestion {
  id             String                   @id @default(uuid())
  siteId         String                   @map("site_id")
  sessionId      String                   @map("session_id")
  userEmail      String?                  @map("user_email")
  question       String
  bestMatchScore Decimal                  @map("best_match_score") @db.Decimal(4, 3)
  timestamp      DateTime
  status         UnansweredQuestionStatus @default(new)
  contactedAt    DateTime?                @map("contacted_at")
  resolvedAt     DateTime?                @map("resolved_at")
  createdAt      DateTime                 @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId, status])
  @@index([createdAt(sort: Desc)])
  @@map("unanswered_questions")
}

model User {
  id           String   @id @default(uuid())
  email        String?  @unique
  passwordHash String?  @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  sites         Site[]
  oauthAccounts OAuthAccount[]

  @@map("users")
}

model WalkthroughStep {
  id              String          @id @default(uuid())
  siteId          String          @map("site_id")
  version         Int             @default(1)
  stepOrder       Int             @map("step_order")
  targetSelectors String[]        @map("target_selectors")
  title           String
  description     String
  position        TooltipPosition @default(bottom)
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@map("walkthrough_steps")
}

model WidgetSession {
  id            String   @id
  siteId        String   @map("site_id")
  ipAddressHash String   @map("ip_address_hash")
  userEmail     String?  @map("user_email")
  messagesCount Int      @default(0) @map("messages_count")
  firstSeenAt   DateTime @default(now()) @map("first_seen_at")
  lastSeenAt    DateTime @default(now()) @map("last_seen_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([lastSeenAt(sort: Desc)])
  @@map("widget_sessions")
}
